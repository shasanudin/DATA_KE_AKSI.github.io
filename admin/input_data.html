<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Data - DATA KE AKSI</title>
    <link rel="stylesheet" href="input_data.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="dashboard-body">

    <aside class="sidebar">
        <div class="sidebar-header">
            <h3>DATA KE AKSI</h3>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="../dashboard.html"><i class="fas fa-home"></i> Beranda</a></li>
                <li class="active"><a href="#"><i class="fas fa-edit"></i> Input Data Baru</a></li>
                <li class="logout-item"><a href="#" id="btnLogout"><i class="fas fa-sign-out-alt"></i> Keluar</a></li>
            </ul>
        </nav>
    </aside>

    <main class="main-content">
        <section class="content-header">
            <h1>Form Input Data Wilayah</h1>
        </section>

        <div class="form-container">
            <form id="formInputData">
                <h3 class="form-section-title">Informasi Wilayah</h3>
                <div class="form-grid">
                    <div class="input-group">
                        <label>Kode Wilayah</label>
                        <input type="text" id="kode" placeholder="Contoh: 3209..." required>
                    </div>
                    <div class="input-group">
                        <label>Nama Kelurahan/Desa</label>
                        <input type="text" id="nama" placeholder="Nama Desa" required>
                    </div>
                    <div class="input-group">
                        <label>Jenis</label>
                        <select id="jenis">
                            <option value="Kelurahan">Kelurahan</option>
                            <option value="Desa">Desa</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Total KK (Otomatis)</label>
                        <input type="number" id="total_kk" readonly style="background:#eee;" value="0">
                    </div>
                </div>

                <h3 class="form-section-title">Data Desil</h3>
                <div class="desil-container">
                    <div class="desil-inputs" id="desilWrapper">
                        <div class="desil-item"><label>D1</label><input type="number" class="val-desil" value="0" min="0"></div>
                        <div class="desil-item"><label>D2</label><input type="number" class="val-desil" value="0" min="0"></div>
                        <div class="desil-item"><label>D3</label><input type="number" class="val-desil" value="0" min="0"></div>
                        <div class="desil-item"><label>D4</label><input type="number" class="val-desil" value="0" min="0"></div>
                        <div class="desil-item"><label>D5</label><input type="number" class="val-desil" value="0" min="0"></div>
                        <div class="desil-item"><label>D6</label><input type="number" class="val-desil" value="0" min="0"></div>
                        <div class="desil-item"><label>D7</label><input type="number" class="val-desil" value="0" min="0"></div>
                        <div class="desil-item"><label>D8</label><input type="number" class="val-desil" value="0" min="0"></div>
                        <div class="desil-item"><label>D9</label><input type="number" class="val-desil" value="0" min="0"></div>
                        <div class="desil-item"><label>D10</label><input type="number" class="val-desil" value="0" min="0"></div>
                    </div>
                </div>

                <div class="btn-submit-container">
                    <p id="message" style="margin-right:20px; font-weight: bold;"></p>
                    <button type="submit" class="btn-primary" id="btnSimpan">SIMPAN DATA</button>
                </div>
            </form>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAhQvRHBYX7dGW7QiSVN24cukmYHrN6d1c",
            authDomain: "data-ke-aksi-auth.firebaseapp.com",
            projectId: "data-ke-aksi-auth",
            storageBucket: "data-ke-aksi-auth.firebasestorage.app",
            messagingSenderId: "631382692174",
            appId: "1:631382692174:web:c10a099fb3021849eace1f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- PROTEKSI HALAMAN ---
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // Jika belum login, paksa ke halaman index
                window.location.href = "../index.html"; 
            }
        });

        // --- TOMBOL LOGOUT ---
        document.getElementById('btnLogout').addEventListener('click', (e) => {
            e.preventDefault();
            signOut(auth).then(() => {
                window.location.href = "../index.html";
            });
        });

        // --- HITUNG OTOMATIS ---
        const inputs = document.querySelectorAll('.val-desil');
        inputs.forEach(input => {
            input.addEventListener('input', () => {
                let total = 0;
                inputs.forEach(i => total += parseInt(i.value) || 0);
                document.getElementById('total_kk').value = total;
            });
        });

        // --- SUBMIT DATA ---
        document.getElementById('formInputData').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSimpan');
            const msg = document.getElementById('message');
            
            btn.disabled = true;
            btn.innerText = "Menyimpan...";
            msg.innerText = "";

            try {
                const desilValues = Array.from(inputs).map(i => parseInt(i.value) || 0);
                
                await addDoc(collection(db, "wilayah_desa"), {
                    kode: document.getElementById('kode').value,
                    nama: document.getElementById('nama').value,
                    jenis: document.getElementById('jenis').value,
                    total_kk: parseInt(document.getElementById('total_kk').value) || 0,
                    desil: desilValues,
                    createdAt: serverTimestamp() // Gunakan waktu server
                });

                msg.innerText = "âœ“ Data berhasil disimpan!";
                msg.style.color = "green";
                e.target.reset();
                document.getElementById('total_kk').value = 0;
            } catch (err) {
                console.error(err);
                msg.innerText = "Gagal: " + err.message;
                msg.style.color = "red";
            } finally {
                btn.disabled = false;
                btn.innerText = "SIMPAN DATA";
            }
        });
    </script>
</body>
</html>
