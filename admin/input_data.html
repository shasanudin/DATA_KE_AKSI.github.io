<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Data - DATA KE AKSI</title>
    <link rel="stylesheet" href="input_data.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="dashboard-body">

    <aside class="sidebar">
        <div class="sidebar-header">
            <h3>DATA KE AKSI</h3>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="../dashboard.html"><i class="fas fa-home"></i> Beranda</a></li>
                <li class="active"><a href="#"><i class="fas fa-edit"></i> Input Data Baru</a></li>
                <li class="logout-item"><a href="#" id="btnLogout"><i class="fas fa-sign-out-alt"></i> Keluar</a></li>
            </ul>
        </nav>
    </aside>

    <main class="main-content">
        <section class="content-header">
            <h1><i class="fas fa-database"></i> Input Data Terpadu Puskesos</h1>
            <p>Update data kesejahteraan wilayah Kecamatan Sumber secara real-time.</p>
        </section>

        <div class="form-container">
            <form id="formInputTerpadu">
                
                <h3 class="form-section-title"><i class="fas fa-map-marker-alt"></i> 1. Informasi Wilayah</h3>
                <div class="form-grid">
                    <div class="input-group">
                        <label>Pilih Kelurahan/Desa</label>
                        <select id="pilih_wilayah" required>
                            <option value="">-- Pilih Wilayah --</option>
                            <option value="Matangaji" data-kode="3209152001" data-jenis="Desa">Matangaji</option>
                            <option value="Sidawangi" data-kode="3209152002" data-jenis="Desa">Sidawangi</option>
                            <option value="Babakan" data-kode="3209151003" data-jenis="Kelurahan">Babakan</option>
                            <option value="Sumber" data-kode="3209151004" data-jenis="Kelurahan">Sumber</option>
                            <option value="Perbutulan" data-kode="3209151005" data-jenis="Kelurahan">Perbutulan</option>
                            <option value="Kaliwadas" data-kode="3209151006" data-jenis="Kelurahan">Kaliwadas</option>
                            <option value="Pasalakan" data-kode="3209151007" data-jenis="Kelurahan">Pasalakan</option>
                            <option value="Watubelah" data-kode="3209151008" data-jenis="Kelurahan">Watubelah</option>
                            <option value="Pejambon" data-kode="3209151009" data-jenis="Kelurahan">Pejambon</option>
                            <option value="Gegunung" data-kode="3209151010" data-jenis="Kelurahan">Gegunung</option>
                            <option value="Kemantren" data-kode="3209151011" data-jenis="Kelurahan">Kemantren</option>
                            <option value="Sendang" data-kode="3209151012" data-jenis="Kelurahan">Sendang</option>
                            <option value="Tukmudal" data-kode="3209151013" data-jenis="Kelurahan">Tukmudal</option>
                            <option value="Kenanga" data-kode="3209151014" data-jenis="Kelurahan">Kenanga</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Kode Wilayah (Otomatis)</label>
                        <input type="text" id="kode" readonly>
                    </div>
                    <div class="input-group">
                        <label>Jenis</label>
                        <input type="text" id="jenis" readonly>
                    </div>
                </div>

                <h3 class="form-section-title"><i class="fas fa-hand-holding-usd"></i> 2. Realisasi Bansos (Jumlah Penerima)</h3>
                <div class="form-grid grid-3">
                    <div class="input-group">
                        <label>BPNT (Sembako)</label>
                        <input type="number" id="bansos_bpnt" value="0">
                    </div>
                    <div class="input-group">
                        <label>PKH</label>
                        <input type="number" id="bansos_pkh" value="0">
                    </div>
                    <div class="input-group">
                        <label>PBI (KIS APBD)</label>
                        <input type="number" id="bansos_pbi" value="0">
                    </div>
                </div>

                <h3 class="form-section-title"><i class="fas fa-users-cog"></i> 3. Pelayanan Puskesos</h3>
                <div class="form-grid grid-3">
                    <div class="input-group">
                        <label>Pembuatan SKTM</label>
                        <input type="number" id="layanan_sktm" value="0">
                    </div>
                    <div class="input-group">
                        <label>Pengaduan</label>
                        <input type="number" id="layanan_pengaduan" value="0">
                    </div>
                    <div class="input-group">
                        <label>Update DTKS</label>
                        <input type="number" id="layanan_dtks" value="0">
                    </div>
                </div>

                <h3 class="form-section-title"><i class="fas fa-chart-line"></i> 4. Data Peringkat Desil</h3>
                <div class="desil-container">
                    <div class="desil-inputs">
                        <div class="desil-item"><label>D1</label><input type="number" class="val-desil" value="0"></div>
                        <div class="desil-item"><label>D2</label><input type="number" class="val-desil" value="0"></div>
                        <div class="desil-item"><label>D3</label><input type="number" class="val-desil" value="0"></div>
                        <div class="desil-item"><label>D4</label><input type="number" class="val-desil" value="0"></div>
                        <div class="desil-item"><label>D5</label><input type="number" class="val-desil" value="0"></div>
                        <div class="desil-item"><label>D6</label><input type="number" class="val-desil" value="0"></div>
                        <div class="desil-item"><label>D7</label><input type="number" class="val-desil" value="0"></div>
                        <div class="desil-item"><label>D8</label><input type="number" class="val-desil" value="0"></div>
                        <div class="desil-item"><label>D9</label><input type="number" class="val-desil" value="0"></div>
                        <div class="desil-item"><label>D10</label><input type="number" class="val-desil" value="0"></div>
                    </div>
                </div>

                <div class="input-group" style="margin-top: 25px;">
                    <label>Total KK Terdata</label>
                    <input type="number" id="total_kk" readonly style="font-size: 1.2rem; border-color: var(--primary-color);">
                </div>

                <div class="btn-submit-container">
                    <p id="message"></p>
                    <button type="submit" class="btn-primary" id="btnSimpan">SIMPAN DATA TERPADU</button>
                </div>
            </form>
        </div>
    </main>

    <script type="module">
        // ... (Script Firebase Anda tetap sama seperti sebelumnya) ...
        // Pastikan logic Auto-Fill dan Hitung Otomatis tetap ada di sini
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAhQvRHBYX7dGW7QiSVN24cukmYHrN6d1c",
            authDomain: "data-ke-aksi-auth.firebaseapp.com",
            projectId: "data-ke-aksi-auth",
            storageBucket: "data-ke-aksi-auth.firebasestorage.app",
            messagingSenderId: "631382692174",
            appId: "1:631382692174:web:c10a099fb3021849eace1f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const selectWilayah = document.getElementById('pilih_wilayah');
        selectWilayah.addEventListener('change', (e) => {
            const opt = e.target.options[e.target.selectedIndex];
            document.getElementById('kode').value = opt.getAttribute('data-kode') || "";
            document.getElementById('jenis').value = opt.getAttribute('data-jenis') || "";
        });

        const desilInputs = document.querySelectorAll('.val-desil');
        desilInputs.forEach(input => {
            input.addEventListener('input', () => {
                let total = 0;
                desilInputs.forEach(i => total += parseInt(i.value) || 0);
                document.getElementById('total_kk').value = total;
            });
        });

        document.getElementById('formInputTerpadu').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSimpan');
            const msg = document.getElementById('message');
            btn.disabled = true; btn.innerText = "Menyimpan...";

            try {
                const desilValues = Array.from(desilInputs).map(i => parseInt(i.value) || 0);
                await addDoc(collection(db, "wilayah_desa"), {
                    nama: selectWilayah.value,
                    kode: document.getElementById('kode').value,
                    jenis: document.getElementById('jenis').value,
                    bansos: {
                        bpnt: parseInt(document.getElementById('bansos_bpnt').value) || 0,
                        pkh: parseInt(document.getElementById('bansos_pkh').value) || 0,
                        pbi: parseInt(document.getElementById('bansos_pbi').value) || 0
                    },
                    layanan: {
                        pengaduan: parseInt(document.getElementById('layanan_pengaduan').value) || 0,
                        sktm: parseInt(document.getElementById('layanan_sktm').value) || 0,
                        dtks: parseInt(document.getElementById('layanan_dtks').value) || 0
                    },
                    desil: desilValues,
                    total_kk: parseInt(document.getElementById('total_kk').value) || 0,
                    createdAt: serverTimestamp()
                });
                msg.innerText = "âœ“ Berhasil!"; msg.style.color = "green";
                e.target.reset();
            } catch (err) {
                msg.innerText = "Gagal: " + err.message;
                msg.style.color = "red";
            } finally {
                btn.disabled = false; btn.innerText = "SIMPAN DATA TERPADU";
            }
        });

        onAuthStateChanged(auth, (u) => { if(!u) window.location.href="../index.html"; });
        document.getElementById('btnLogout').addEventListener('click', () => signOut(auth));
    </script>
</body>
</html>
