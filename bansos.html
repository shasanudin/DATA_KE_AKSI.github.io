<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Data Bansos | TKSK & Puskesos Sumber</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --primary: #007bff; --success: #28a745; --danger: #dc3545;
        }
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; }
        .card-custom { border: none; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); background: white; }
        .stat { font-weight: 700; font-size: 1.6rem; }
        .table thead th { background-color: #f8f9fa; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; }
        footer { background: #212529; color: #aaa; }
    </style>
</head>
<body>

<div id="navbar"></div>

<div class="container my-5">
    <div class="d-flex align-items-center mb-4">
        <div class="mr-3 bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
            <i class="fas fa-hand-holding-heart fa-lg"></i>
        </div>
        <div>
            <h3 class="font-weight-bold mb-0">Monitor Bantuan Sosial</h3>
            <p class="text-muted mb-0">Integrasi Data PKH, BPNT, dan PBI</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card card-custom p-3 border-left border-primary" style="border-left-width: 5px !important;">
                <p class="small text-muted mb-1 font-weight-bold">TOTAL KK</p>
                <div id="totalKK" class="stat">0</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card card-custom p-3 border-left border-primary" style="border-left-width: 5px !important;">
                <p class="small text-muted mb-1 font-weight-bold">PENERIMA PKH</p>
                <div id="totalPKH" class="stat text-primary">0</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card card-custom p-3 border-left border-success" style="border-left-width: 5px !important;">
                <p class="small text-muted mb-1 font-weight-bold">PENERIMA BPNT</p>
                <div id="totalBPNT" class="stat text-success">0</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card card-custom p-3 border-left border-danger" style="border-left-width: 5px !important;">
                <p class="small text-muted mb-1 font-weight-bold">PENERIMA PBI</p>
                <div id="totalPBI" class="stat text-danger">0</div>
            </div>
        </div>
    </div>

    <div class="card card-custom p-0 mb-4 overflow-hidden">
        <div class="p-3 border-bottom bg-light">
            <h6 class="font-weight-bold mb-0"><i class="fas fa-table mr-2"></i>Rincian Bantuan Per Desa</h6>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th class="pl-4">Nama Desa</th>
                        <th class="text-center">Total KK</th>
                        <th class="text-center">PKH</th>
                        <th class="text-center">BPNT</th>
                        <th class="text-center">PBI</th>
                        <th class="text-center">Cakupan</th>
                    </tr>
                </thead>
                <tbody id="bansosTable">
                    <tr><td colspan="6" class="text-center py-4">Menghubungkan ke database...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card card-custom p-4">
        <h6 class="font-weight-bold mb-3"><i class="fas fa-chart-bar mr-2"></i>Visualisasi Distribusi</h6>
        <div style="height: 350px;">
            <canvas id="bansosChart"></canvas>
        </div>
    </div>
</div>

<footer class="py-4 text-center mt-5">
    <p class="small mb-0">Â© 2026 Puskesos Kecamatan Sumber | Real-time Data Service</p>
</footer>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAhQvRHBYX7dGW7QiSVN24cukmYHrN6d1c",
        authDomain: "data-ke-aksi-auth.firebaseapp.com",
        projectId: "data-ke-aksi-auth",
        storageBucket: "data-ke-aksi-auth.firebasestorage.app",
        messagingSenderId: "631382692174",
        appId: "1:631382692174:web:c10a099fb3021849eace1f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let bansosChart;

    fetch('navbar.html').then(r => r.text()).then(h => document.getElementById('navbar').innerHTML = h);

    function initBansosMonitor() {
        onSnapshot(collection(db, "wilayah_desa"), (snapshot) => {
            let tKK = 0, tPKH = 0, tBPNT = 0, tPBI = 0;
            let rows = "";
            let labels = [], dPKH = [], dBPNT = [], dPBI = [];

            const dataDesa = snapshot.docs.map(doc => doc.data())
                             .sort((a, b) => a.nama.localeCompare(b.nama));

            dataDesa.forEach(w => {
                // Sesuai format (map) bansos: bpnt, pbi, pkh
                const b = w.bansos || {};
                const pkh = parseInt(b.pkh || 0);
                const bpnt = parseInt(b.bpnt || 0);
                const pbi = parseInt(b.pbi || 0);
                const kk = parseInt(w.total_kk || 0);

                tKK += kk; tPKH += pkh; tBPNT += bpnt; tPBI += pbi;

                const totalBansos = pkh + bpnt + pbi;
                const rasio = kk > 0 ? ((totalBansos / kk) * 100).toFixed(1) : 0;

                rows += `
                <tr>
                    <td class="pl-4 font-weight-bold">${w.nama}</td>
                    <td class="text-center">${kk}</td>
                    <td class="text-center text-primary font-weight-bold">${pkh}</td>
                    <td class="text-center text-success font-weight-bold">${bpnt}</td>
                    <td class="text-center text-danger font-weight-bold">${pbi}</td>
                    <td class="text-center"><span class="badge badge-light border text-dark">${rasio}%</span></td>
                </tr>`;

                labels.push(w.nama);
                dPKH.push(pkh); dBPNT.push(bpnt); dPBI.push(pbi);
            });

            document.getElementById('totalKK').innerText = tKK.toLocaleString('id-ID');
            document.getElementById('totalPKH').innerText = tPKH.toLocaleString('id-ID');
            document.getElementById('totalBPNT').innerText = tBPNT.toLocaleString('id-ID');
            document.getElementById('totalPBI').innerText = tPBI.toLocaleString('id-ID');
            document.getElementById('bansosTable').innerHTML = rows;

            renderChart(labels, dPKH, dBPNT, dPBI);
        });
    }

    function renderChart(labels, pkh, bpnt, pbi) {
        const ctx = document.getElementById('bansosChart').getContext('2d');
        if (bansosChart) bansosChart.destroy();
        bansosChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'PKH', data: pkh, backgroundColor: '#007bff' },
                    { label: 'BPNT', data: bpnt, backgroundColor: '#28a745' },
                    { label: 'PBI', data: pbi, backgroundColor: '#dc3545' }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    initBansosMonitor();
</script>
</body>
</html>
