<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Data DTSEN | TKSK & Puskesos Sumber</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<header class="container py-3">
  <div class="row align-items-center text-center">
    <div class="col-md-4 text-left">
      <img src="assets/img/logo/logo-tksk.png" alt="Logo" height="50">
      <img src="assets/img/logo/logo-puskesos.png" alt="Logo" height="50">
    </div>
    <div class="col-md-4">
      <h3 class="mb-0 font-weight-bold">DARI DATA KE AKSI</h3>
      <small>Kecamatan Sumber</small>
    </div>
  </div>
</header>

<div id="navbar"></div>

<main class="container py-4">
  <h2>Data DTSEN Kecamatan Sumber</h2>
  <p class="text-muted">Ringkasan data kesejahteraan berbasis wilayah.</p>
  <hr>

  <h4 class="mt-4">Distribusi DTSEN Kecamatan (Agregasi)</h4>
  <div class="table-responsive col-md-6 px-0">
    <table class="table table-bordered table-sm text-center">
      <thead class="thead-light">
        <tr>
          <th>Kategori Desil</th>
          <th>Total KK</th>
        </tr>
      </thead>
      <tbody id="tabelDesilKecamatan">
        </tbody>
    </table>
  </div>

  <div class="form-group col-md-4 px-0 mt-5">
    <label><strong>Pilih Desa / Kelurahan</strong></label>
    <select id="wilayahSelect" class="form-control"></select>
  </div>

  <div class="row text-center mb-4">
    <div class="col-md-2 mb-2">
      <div class="card shadow-sm"><div class="card-body p-2"><h4 id="totalKK">—</h4><small>Total KK</small></div></div>
    </div>
    <div class="col-md-2 mb-2">
      <div class="card shadow-sm border-danger"><div class="card-body p-2"><h4 id="desil1">—</h4><small>Desil 1</small></div></div>
    </div>
    <div class="col-md-2 mb-2">
      <div class="card shadow-sm border-warning"><div class="card-body p-2"><h4 id="desil2">—</h4><small>Desil 2</small></div></div>
    </div>
    <div class="col-md-2 mb-2">
      <div class="card shadow-sm"><div class="card-body p-2"><h4 id="desil3">—</h4><small>Desil 3</small></div></div>
    </div>
    <div class="col-md-2 mb-2">
      <div class="card shadow-sm"><div class="card-body p-2"><h4 id="desil4">—</h4><small>Desil 4</small></div></div>
    </div>
    <div class="col-md-2 mb-2">
      <div class="card shadow-sm border-success"><div class="card-body p-2"><h4 id="desil510">—</h4><small>Desil 6-10</small></div></div>
    </div>
  </div>

  <canvas id="desilChart" height="100"></canvas>
  <p class="mt-3 small text-muted">Pembaruan data: <span id="updateData">-</span></p>
</main>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let chart;
fetch('data/dtsen.json')
  .then(res => res.json())
  .then(data => {
    const select = document.getElementById('wilayahSelect');
    const updateDataEl = document.getElementById('updateData');
    const tabelKec = document.getElementById('tabelDesilKecamatan');

    updateDataEl.innerText = data.updated;

    // 1. PROSES TABEL KECAMATAN (D6-10 Digabung)
    let agregat = Array(10).fill(0);
    data.wilayah.forEach(w => {
      w.desil.forEach((val, i) => { agregat[i] += val; });
    });

    let rowHtml = "";
    // Render D1 sampai D5
    for(let i=0; i<5; i++) {
      rowHtml += `<tr><td>Desil ${i+1}</td><td>${agregat[i].toLocaleString('id-ID')}</td></tr>`;
    }
    // Gabungkan D6 sampai D10 (indeks 5 sampai 9)
    let gabungD610 = agregat.slice(5).reduce((a, b) => a + b, 0);
    rowHtml += `<tr class="table-success"><td><strong>Desil 6-10</strong></td><td><strong>${gabungD610.toLocaleString('id-ID')}</strong></td></tr>`;
    tabelKec.innerHTML = rowHtml;

    // 2. DROPDOWN MENU
    data.wilayah.forEach((w, i) => {
      const opt = document.createElement('option');
      opt.value = i; opt.textContent = w.nama;
      select.appendChild(opt);
    });

    // 3. FUNGSI RENDER DETAIL WILAYAH
    function renderWilayah(idx) {
      const w = data.wilayah[idx];
      const d = w.desil;

      document.getElementById('totalKK').innerText = w.total_kk.toLocaleString('id-ID');
      document.getElementById('desil1').innerText = d[0] + '%';
      document.getElementById('desil2').innerText = d[1] + '%';
      document.getElementById('desil3').innerText = d[2] + '%';
      document.getElementById('desil4').innerText = d[3] + '%';
      
      // Gabungkan D6-D10 untuk Card
      const total610 = d.slice(5).reduce((a, b) => a + b, 0);
      document.getElementById('desil510').innerText = total610 + '%';

      // 4. CHART (Menampilkan D1-D5 secara individu, dan satu batang untuk D6-10)
      const ctx = document.getElementById('desilChart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['D1', 'D2', 'D3', 'D4', 'D5', 'D6-10'],
          datasets: [{
            label: 'Persentase (%)',
            data: [d[0], d[1], d[2], d[3], d[4], total610],
            backgroundColor: ['#dc3545', '#ffc107', '#0d6efd', '#6610f2', '#fd7e14', '#28a745']
          }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    }

    select.addEventListener('change', e => renderWilayah(e.target.value));
    renderWilayah(0);
  });
</script>
</body>
</html>
