<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Data DTSEN | TKSK & Puskesos Sumber</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<style>
body { font-family: Inter, sans-serif; background:#f4f7f6; }
.card-custom { border-radius:16px; box-shadow:0 4px 14px rgba(0,0,0,0.08); }
.stat { font-size:1.5rem; font-weight:800; }

        :root {
            --primary: #007bff;
            --secondary: #0056b3;
            --danger: #dc3545;
            --warning: #ffc107;
            --success: #28a745;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f4f7f6; 
            color: #333; 
        }

        /* Hero Header */
        .data-hero {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 50px 0;
            margin-bottom: 30px;
            border-radius: 0 0 30px 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* Cards Styling */
        .card-custom {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
            background: white;
        }
        .card-custom:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 0;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Table Styling */
        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .table thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            text-transform: uppercase;
            font-size: 0.75rem;
        }

        .section-title {
            font-weight: 700;
            position: relative;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .section-title::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 40px;
            height: 4px;
            background: var(--primary);
            border-radius: 2px;
        }

        select.form-control {
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            height: 45px;
            font-weight: 600;
        }
        select.form-control:focus {
            border-color: var(--primary);
            box-shadow: none;
        }

        footer { background: #212529; color: #aaa; }
</style>
</head>
<body>

<header class="container py-3 bg-white">
    <div class="row align-items-center">
        <div class="col-md-6 text-center text-md-left">
            <img src="assets/img/logo/logo-tksk.png" alt="TKSK" height="45">
            <img src="assets/img/logo/logo-puskesos.png" alt="Puskesos" height="45" class="ml-2 border-left pl-2">
        </div>
        <div class="col-md-6 text-right d-none d-md-block">
            <span class="badge badge-primary px-3 py-2">Satu Data Terpadu</span>
        </div>
        <div class="container my-5">

        <h3 class="font-weight-bold mb-2">Sistem Evaluasi Bansos Terintegrasi</h3>
        <p class="text-muted mb-4">Deteksi salah sasaran, kekurangan bantuan, dan prioritas kebijakan</p>
        </div>
    </div>
</header>

<div id="navbar"></div>


<!-- KPI -->
<div class="row mb-4">

<div class="col-md-3 mb-3">
<div class="card card-custom p-3">
<p class="small text-muted mb-1">Total KK Miskin (D1–D2)</p>
<div id="totalMiskin" class="stat text-danger">—</div>
</div>
</div>

<div class="col-md-3 mb-3">
<div class="card card-custom p-3">
<p class="small text-muted mb-1">Sudah Tercover</p>
<div id="covered" class="stat text-success">—</div>
</div>
</div>

<div class="col-md-3 mb-3">
<div class="card card-custom p-3">
<p class="small text-muted mb-1">Belum Tercover (GAP)</p>
<div id="gap" class="stat text-warning">—</div>
</div>
</div>

<div class="col-md-3 mb-3">
<div class="card card-custom p-3">
<p class="small text-muted mb-1">Potensi Salah Sasaran</p>
<div id="leakage" class="stat text-primary">—</div>
</div>
</div>

</div>

<!-- TABLE -->
<div class="card card-custom p-4 mb-4">
<h5 class="font-weight-bold mb-3">Evaluasi Bansos per Desa/Kelurahan</h5>
<table class="table table-bordered table-sm">
<thead>
<tr>
<th>Wilayah</th>
<th>D1</th>
<th>D2</th>
<th>Total Miskin</th>
<th>Total Bansos</th>
<th>Covered</th>
<th>GAP</th>
<th>Leakage</th>
<th>Status</th>
</tr>
</thead>
<tbody id="evalTable"></tbody>
</table>
</div>

<!-- Chart -->
<div class="card card-custom p-4 mb-4">
<h5 class="font-weight-bold mb-3">Grafik GAP vs Coverage</h5>
<canvas id="evalChart" height="120"></canvas>
</div>

<!-- RECOMMENDATION -->
<div class="card card-custom p-4">
<h5 class="font-weight-bold mb-3">Rekomendasi Kebijakan Otomatis</h5>
<ul id="recommendations"></ul>
</div>

</div>

<script>
// 1. Muat Navbar (Konsisten dengan Beranda)
fetch('navbar.html')
    .then(r => r.text())
    .then(html => {
        document.getElementById('navbar').innerHTML = html;
    });
  
Promise.all([
    fetch('data/dtsen.json').then(r => r.json()),
    fetch('data/bansos.json').then(r => r.json())
])
.then(([dtsen, bansos]) => {

    let totalMiskin = 0;
    let totalCovered = 0;
    let totalGap = 0;
    let totalLeakage = 0;

    let tableRows = [];
    let chartLabels = [];
    let chartGap = [];
    let chartCovered = [];

    dtsen.wilayah.forEach(w => {
        let d1 = w.desil[0];
        let d2 = w.desil[1];
        let miskin = d1 + d2;

        let match = bansos.wilayah.find(b => b.nama === w.nama);
        let bansosTotal = match 
            ? (match.bansos.PKH + match.bansos.BPNT + match.bansos.PBI)
            : 0;

        let covered = Math.min(miskin, bansosTotal);
        let gap = Math.max(0, miskin - bansosTotal);
        let leakage = Math.max(0, bansosTotal - miskin);

        totalMiskin += miskin;
        totalCovered += covered;
        totalGap += gap;
        totalLeakage += leakage;

        let status = "Seimbang";
        if (gap > miskin * 0.2) status = "KRITIS (Kurang Bantuan)";
        if (leakage > miskin * 0.2) status = "ANOMALI (Potensi Salah Sasaran)";

        tableRows.push(`
        <tr>
            <td>${w.nama}</td>
            <td class="text-center">${d1}</td>
            <td class="text-center">${d2}</td>
            <td class="text-center font-weight-bold">${miskin}</td>
            <td class="text-center">${bansosTotal}</td>
            <td class="text-center text-success">${covered}</td>
            <td class="text-center text-warning">${gap}</td>
            <td class="text-center text-primary">${leakage}</td>
            <td class="font-weight-bold">${status}</td>
        </tr>`);

        chartLabels.push(w.nama);
        chartGap.push(gap);
        chartCovered.push(covered);
    });

    document.getElementById('totalMiskin').innerText = totalMiskin.toLocaleString('id-ID');
    document.getElementById('covered').innerText = totalCovered.toLocaleString('id-ID');
    document.getElementById('gap').innerText = totalGap.toLocaleString('id-ID');
    document.getElementById('leakage').innerText = totalLeakage.toLocaleString('id-ID');

    document.getElementById('evalTable').innerHTML = tableRows.join('');

    // Chart
    const ctx = document.getElementById('evalChart');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartLabels,
            datasets: [
                { label: 'GAP (Belum Terbantu)', data: chartGap, backgroundColor:'#ffc107' },
                { label: 'Covered', data: chartCovered, backgroundColor:'#28a745' }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'top' } }
        }
    });

    // Recommendations
    let rec = document.getElementById('recommendations');

    if (totalGap > totalMiskin * 0.25) {
        rec.innerHTML += `<li><b>Darurat:</b> Perluasan bansos segera untuk keluarga miskin ekstrem</li>`;
    }
    if (totalLeakage > totalMiskin * 0.15) {
        rec.innerHTML += `<li><b>Audit Targeting:</b> Indikasi salah sasaran penerima</li>`;
    }

    rec.innerHTML += `<li><b>Fokus Intervensi Prioritas:</b> ${chartLabels.slice(0,3).join(', ')}</li>`;
});
</script>

</body>
</html>
