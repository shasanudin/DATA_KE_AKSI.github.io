<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Internal Signer | TKSK Sumber</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { background-color: #0f172a; color: #f1f5f9; font-family: 'Segoe UI', sans-serif; padding-top: 50px; }
        .signer-card { background: #1e293b; border: 1px solid #334155; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); padding: 30px; }
        .form-control { background-color: #0f172a; border: 1px solid #334155; color: #38b2ac !important; font-family: 'Courier New', Courier, monospace; }
        .form-control:focus { background-color: #1a202c; border-color: #38b2ac; box-shadow: none; }
        .btn-sign { background: #38b2ac; border: none; font-weight: bold; transition: 0.3s; }
        .btn-sign:hover { background: #319795; transform: translateY(-2px); }
        #output { 
            background: #000; color: #4ade80; padding: 20px; border-radius: 12px; 
            font-size: 0.85rem; min-height: 100px; cursor: pointer; border: 1px dashed #334155;
            white-space: pre-wrap; word-break: break-all;
        }
        .status-badge { font-size: 0.75rem; padding: 5px 12px; border-radius: 20px; }
    </style>
</head>
<body>

<div class="container mb-5">
    <div class="row justify-content-center">
        <div class="col-md-9 signer-card">
            <div class="text-center mb-4">
                <h2 class="font-weight-bold text-info"><i class="fas fa-file-signature"></i> TKSK DIGITAL SIGNER</h2>
                <p class="text-muted">Gunakan alat ini secara offline untuk mengunci data laporan.</p>
                <div id="connectionStatus" class="status-badge badge-secondary">Menghubungkan ke Public Key...</div>
            </div>

            <hr class="border-secondary">

            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">
                        <label class="small font-weight-bold text-uppercase">1. Private Key (Format PEM)</label>
                        <textarea id="privKey" class="form-control" rows="5" placeholder="-----BEGIN PRIVATE KEY-----&#10;...&#10;-----END PRIVATE KEY-----"></textarea>
                        <small class="text-muted italic">Kunci ini tidak akan dikirim ke server manapun.</small>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="small font-weight-bold text-uppercase">2. ID Laporan</label>
                        <input type="text" id="docID" class="form-control" placeholder="DTSEN-2026-001">
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="form-group">
                        <label class="small font-weight-bold text-uppercase">3. Isi Pesan (MSG) untuk Divalidasi</label>
                        <input type="text" id="docMsg" class="form-control" placeholder="Contoh: Kec-Sumber-TotalKK:54201">
                    </div>
                </div>
            </div>

            <button onclick="processSignature()" class="btn btn-sign btn-block btn-lg mt-3">
                <i class="fas fa-shield-alt"></i> VERIFIKASI & TANDA TANGANI
            </button>

            <div class="mt-4">
                <label class="small font-weight-bold text-uppercase text-info">Hasil JSON (Salin untuk QR Code):</label>
                <div id="output" onclick="copyResult()">// Menunggu input...</div>
                <small class="text-muted d-block mt-2"><i class="fas fa-info-circle"></i> Klik pada kotak hitam untuk menyalin hasil.</small>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.25/jsrsasign-all-min.js"></script>

<script>
    let publicKeyPEM = "";

    // Load Public Key dari JSON pusat
    async function loadPublicKey() {
        try {
            const res = await fetch('js/public_key.json');
            const data = await res.json();
            publicKeyPEM = data.pem;
            
            const badge = document.getElementById('connectionStatus');
            badge.className = "status-badge badge-success";
            badge.innerHTML = `<i class="fas fa-check-circle"></i> Terhubung ke: ${data.pemilik}`;
        } catch (e) {
            const badge = document.getElementById('connectionStatus');
            badge.className = "status-badge badge-danger";
            badge.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Gagal memuat public_key.json`;
        }
    }
    loadPublicKey();

    function processSignature() {
        const privPEM = document.getElementById('privKey').value.trim();
        const msg = document.getElementById('docMsg').value.trim();
        const id = document.getElementById('docID').value.trim();
        const output = document.getElementById('output');

        if (!privPEM || !msg || !id) {
            alert("Harap lengkapi semua data!");
            return;
        }

        try {
            // --- VALIDASI PASANGAN KUNCI ---
            // 1. Buat signature percobaan dengan Private Key input
            const sigTest = new KJUR.crypto.Signature({"alg": "SHA256withECDSA"});
            sigTest.init(privPEM);
            sigTest.updateString("verify-key-pair");
            const testHex = sigTest.sign();

            // 2. Verifikasi dengan Public Key dari JSON
            const verifyTest = new KJUR.crypto.Signature({"alg": "SHA256withECDSA"});
            verifyTest.init(publicKeyPEM);
            verifyTest.updateString("verify-key-pair");
            
            const isMatch = verifyTest.verify(testHex);

            if (!isMatch) {
                throw new Error("Private Key tidak cocok dengan Public Key di server!");
            }

            // --- PROSES TANDA TANGAN ASLI ---
            const finalSig = new KJUR.crypto.Signature({"alg": "SHA256withECDSA"});
            finalSig.init(privPEM);
            finalSig.updateString(msg);
            const sigHex = finalSig.sign();

            const finalJSON = {
                id: id,
                msg: msg,
                sig: sigHex
            };

            output.innerText = JSON.stringify(finalJSON, null, 2);
            output.style.color = "#4ade80";
            alert("VERIFIKASI SUKSES!\nKunci cocok dan tanda tangan berhasil dibuat.");

        } catch (e) {
            output.innerText = "ERROR: " + e.message;
            output.style.color = "#f87171";
            alert("VERIFIKASI GAGAL: " + e.message);
        }
    }

    function copyResult() {
        const text = document.getElementById('output').innerText;
        if (text.includes("//") || text.includes("ERROR")) return;
        
        navigator.clipboard.writeText(text).then(() => {
            alert("JSON disalin ke clipboard!");
        });
    }
</script>

</body>
</html>
