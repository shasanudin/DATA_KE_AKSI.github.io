<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Laporan DTSEN | TKSK Kec. Sumber</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        :root { --primary: #007bff; --secondary: #0056b3; --dark-bg: #f4f7f6; }
        body { background-color: var(--dark-bg); font-family: 'Inter', sans-serif; }
        .hero-print { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 40px 0; margin-bottom: -50px; }
        .control-panel { background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); padding: 25px; position: relative; z-index: 10; }
        .paper { background: white; width: 210mm; min-height: 297mm; padding: 15mm 20mm; margin: 30px auto; box-shadow: 0 0 20px rgba(0,0,0,0.05); font-family: "Times New Roman", Times, serif; color: #000; }
        .kop-surat-container { display: flex; align-items: center; justify-content: space-between; border-bottom: 3px solid #000; padding-bottom: 10px; }
        .logo-box { width: 85px; flex-shrink: 0; }
        .logo-kop { width: 100%; height: auto; }
        .teks-kop { text-align: center; flex-grow: 1; }
        .kop-line { border-bottom: 1px solid #000; margin-top: 2px; margin-bottom: 20px; }
        .qr-box { border: 1px solid #eee; padding: 5px; background: #fff; display: inline-block; }
        @media print {
            body { background: white !important; }
            .no-print, header { display: none !important; }
            .paper { margin: 0 !important; box-shadow: none !important; width: 100% !important; padding: 10mm !important; }
            @page { size: A4; margin: 0; }
        }
    </style>
</head>
<body>

<header class="container-fluid py-3 bg-white no-print">
    <div class="container d-flex justify-content-between align-items-center">
        <img src="assets/img/logo/logo-tksk.png" height="40">
        <span class="badge badge-primary px-3 py-2">Mode Admin: Laporan Terpadu</span>
    </div>
</header>

<section class="hero-print no-print">
    <div class="container text-center">
        <h2 class="font-weight-bold">Panel Cetak Laporan DTSEN</h2>
        <p>Filter data Desil 6-10 dan Prioritas D1-D2 secara otomatis.</p>
    </div>
</section>

<div class="container no-print mt-5">
    <div class="control-panel">
        <div class="row align-items-end">
            <div class="col-md-3">
                <label class="small font-weight-bold text-muted">KATEGORI LAPORAN</label>
                <select id="tipeLaporan" class="form-control" onchange="toggleWilayah()">
                    <option value="agregat">Agregasi Desil 6-10</option>
                    <option value="prioritas">Daftar Prioritas (D1-D2)</option>
                    <option value="perdesa">Detail Per Desa</option>
                </select>
            </div>
            <div class="col-md-3" id="wilayahContainer" style="display:none;">
                <label class="small font-weight-bold text-muted">PILIH DESA</label>
                <select id="selectDesa" class="form-control"></select>
            </div>
            <div class="col-md-6 text-right">
                <button onclick="loadAndGenerate()" class="btn btn-primary px-4">
                    <i class="fas fa-sync-alt mr-2"></i>Generate
                </button>
                <button onclick="window.print()" class="btn btn-dark px-4 ml-2">
                    <i class="fas fa-print mr-2"></i>Cetak PDF
                </button>
            </div>
        </div>
    </div>
</div>

<div class="paper" id="cetakArea">
    <div class="kop-surat-container">
        <div class="logo-box"><img src="assets/img/logo/logo-tksk.png" class="logo-kop"></div>
        <div class="teks-kop">
            <h6 style="font-size: 14px; margin: 0;">TENAGA KESEJAHTERAAN SOSIAL KECAMATAN (TKSK)</h6>
            <h5 class="font-weight-bold" style="font-size: 16px; margin: 2px 0;">FORUM PUSKESOS KECAMATAN SUMBER</h5>
            <h2 class="font-weight-bold" style="font-size: 26px; margin: 4px 0; letter-spacing: 1px;">DARI DATA KE AKSI</h2>
            <p class="mb-0" style="font-size: 11px; font-family: Arial;">Sekretariat: Jl. Sunan Drajat No. 16, Kec. Sumber, Kab. Cirebon 45611</p>
        </div>
        <div class="logo-box text-right"><img src="assets/img/logo/logo-puskesos.png" class="logo-kop"></div>
    </div>
    <div class="kop-line"></div>

    <div class="text-center mb-4">
        <h5 id="judulLaporan" class="font-weight-bold text-uppercase" style="text-decoration: underline;">MEMPROSES LAPORAN...</h5>
        <p class="mb-0">Nomor: 460 / <span id="hashNomor">...</span> / TKSK-SBR / 2026</p>
    </div>

    <div id="kontenData" style="min-height: 500px;">
        <p class="text-center mt-5">Klik tombol <b>Generate</b> untuk memuat data.</p>
    </div>

    <div class="row mt-4">
        <div class="col-7">
            <div style="border: 1px solid #000; padding: 8px; font-size: 10px; font-family: Arial;">
                <strong>Catatan Verifikasi:</strong><br>
                - Data Agregat mencakup akumulasi Desil 6 hingga 10.<br>
                - Daftar Prioritas difilter berdasarkan kode kerentanan D1 dan D2.
            </div>
        </div>
        <div class="col-5 text-center">
            <p class="mb-1" style="font-size: 14px;">Sumber, <span id="tglSekarang"></span></p>
            <p class="mb-4 font-weight-bold" style="font-size: 14px;">TKSK Kecamatan Sumber,</p>
            <div id="qrcode" class="qr-box mb-2"></div>
            <p class="font-weight-bold mb-0" style="text-decoration: underline; font-size: 15px;">SHIDIQ HASANUDIN, S.IP</p>
            <small>ID Verif: <span id="hashID">-</span></small>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
    let rawData = [];
    const hashID = Math.random().toString(36).substring(2, 8).toUpperCase();

    // Inisialisasi awal
    window.onload = () => {
        document.getElementById('tglSekarang').innerText = new Date().toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'});
        document.getElementById('hashNomor').innerText = Math.floor(100 + Math.random() * 899);
        document.getElementById('hashID').innerText = hashID;
        loadInitialData(); // Load data desa untuk dropdown
    };

    function toggleWilayah() {
        const tipe = document.getElementById('tipeLaporan').value;
        document.getElementById('wilayahContainer').style.display = (tipe === 'perdesa') ? 'block' : 'none';
    }

    async function loadInitialData() {
        try {
            const res = await fetch('dtsen.json');
            rawData = await res.json();
            
            // Isi dropdown desa secara unik
            const desaUnik = [...new Set(rawData.map(item => item.desa))].sort();
            const select = document.getElementById('selectDesa');
            desaUnik.forEach(desa => {
                let opt = document.createElement('option');
                opt.value = desa;
                opt.innerHTML = desa;
                select.appendChild(opt);
            });
        } catch (e) { console.error("Gagal load data desa"); }
    }

    async function loadAndGenerate() {
        const konten = document.getElementById('kontenData');
        const tipe = document.getElementById('tipeLaporan').value;
        const judul = document.getElementById('judulLaporan');
        
        konten.innerHTML = '<div class="text-center mt-5"><div class="spinner-border text-primary"></div><p>Sinkronisasi Database...</p></div>';

        try {
            const res = await fetch('data/dtsen.json');
            const data = await res.json();
            
            let filteredHtml = '';

            if (tipe === 'agregat') {
                judul.innerText = "LAPORAN AGREGASI DATA (DESIL 6 - 10)";
                filteredHtml = renderAgregat(data);
            } else if (tipe === 'prioritas') {
                judul.innerText = "DAFTAR PRIORITAS PENERIMA (D1 - D2)";
                filteredHtml = renderPrioritas(data);
            } else {
                const desaTerpilih = document.getElementById('selectDesa').value;
                judul.innerText = "LAPORAN DETAIL DATA DESA " + desaTerpilih.toUpperCase();
                filteredHtml = renderPerDesa(data, desaTerpilih);
            }

            konten.innerHTML = filteredHtml;
            updateQR(tipe);

        } catch (error) {
            konten.innerHTML = '<div class="alert alert-danger">File dtsen.json tidak ditemukan atau format salah.</div>';
        }
    }

    function renderAgregat(data) {
        // Filter Desil 6-10 dan Kelompokkan per Desa
        const filterDesil = data.filter(item => item.desil >= 6 && item.desil <= 10);
        const rekap = {};
        
        filterDesil.forEach(item => {
            rekap[item.desa] = (rekap[item.desa] || 0) + 1;
        });

        let rows = '';
        let total = 0;
        Object.keys(rekap).sort().forEach((desa, idx) => {
            rows += `<tr><td class="text-center">${idx+1}</td><td>${desa}</td><td class="text-center">${rekap[desa]}</td><td class="text-center">Tervalidasi</td></tr>`;
            total += rekap[desa];
        });

        return `
            <table class="table table-bordered table-sm" style="font-size: 13px;">
                <thead class="bg-light text-center">
                    <tr><th>No</th><th>Nama Desa</th><th>Jumlah KPM (Desil 6-10)</th><th>Keterangan</th></tr>
                </thead>
                <tbody>${rows}</tbody>
                <tfoot class="font-weight-bold"><tr><td colspan="2" class="text-right">TOTAL KECAMATAN:</td><td class="text-center">${total}</td><td></td></tr></tfoot>
            </table>`;
    }

    function renderPrioritas(data) {
        // Filter Prioritas D1 dan D2
        const filterD = data.filter(item => item.prioritas === 'D1' || item.prioritas === 'D2');
        
        let rows = '';
        filterD.slice(0, 50).forEach((item, idx) => { // Limit 50 untuk preview cetak
            rows += `<tr>
                <td class="text-center">${idx+1}</td>
                <td>${item.nama}</td>
                <td>${item.desa}</td>
                <td class="text-center"><b>${item.prioritas}</b></td>
                <td>${item.alamat || '-'}</td>
            </tr>`;
        });

        return `
            <table class="table table-bordered table-sm" style="font-size: 11px;">
                <thead class="bg-light text-center">
                    <tr><th>No</th><th>Nama Lengkap</th><th>Asal Desa</th><th>Skala</th><th>Alamat/Ket</th></tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>`;
    }

    function renderPerDesa(data, desa) {
        const filterDesa = data.filter(item => item.desa === desa);
        let rows = '';
        filterDesa.forEach((item, idx) => {
            rows += `<tr>
                <td class="text-center">${idx+1}</td>
                <td>${item.nama}</td>
                <td class="text-center">${item.desil}</td>
                <td class="text-center">${item.prioritas || '-'}</td>
                <td>${item.status_sosial || 'Aktif'}</td>
            </tr>`;
        });

        return `
            <p>Total Data di Desa ${desa}: <b>${filterDesa.length} KPM</b></p>
            <table class="table table-bordered table-sm" style="font-size: 11px;">
                <thead class="bg-light text-center">
                    <tr><th>No</th><th>Nama Lengkap</th><th>Desil</th><th>Prioritas</th><th>Status</th></tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>`;
    }

    function updateQR(tipe) {
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById("qrcode"), {
            text: `VERIF-TKSK-${tipe.toUpperCase()}-${hashID}`,
            width: 70, height: 70
        });
    }
</script>
</body>
</html>
