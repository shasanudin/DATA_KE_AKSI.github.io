<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cetak Dokumen DTSEN | TKSK Sumber</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #f4f4f4; font-family: "Times New Roman", Times, serif; }
        .paper {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: 20px auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
        }
        .kop-surat {
            border-bottom: 3px double #000;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }
        .logo-kop { height: 80px; }
        .qr-section { margin-top: 50px; }
        #qrcode img { margin: 0 auto; }
        
        @media print {
            body { background: none; }
            .paper { margin: 0; box-shadow: none; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>

<div class="container no-print py-4 text-center">
    <button onclick="window.print()" class="btn btn-primary">Cetak / Simpan PDF</button>
    <a href="index.html" class="btn btn-secondary">Kembali</a>
</div>

<div class="paper" id="surat">
    <div class="kop-surat">
        <div class="row align-items-center">
            <div class="col-2 text-center">
                <img src="assets/img/logo/logo-tksk.png" class="logo-kop" alt="Logo TKSK">
            </div>
            <div class="col-8 text-center">
                <h4 class="mb-0">TENAGA KESEJAHTERAAN SOSIAL KECAMATAN</h4>
                <h5 class="mb-0">KECAMATAN SUMBER - KABUPATEN CIREBON</h5>
                <h3 class="font-weight-bold">DARI DATA KE AKSI</h3>
                <p class="mb-0 small">Sekretariat: Kantor Kecamatan Sumber, Jl. Raden Dewi Sartika No. 1</p>
            </div>
            <div class="col-2 text-center">
                <img src="assets/img/logo/logo-puskesos.png" class="logo-kop" alt="Logo Puskesos">
            </div>
        </div>
    </div>

    <div class="text-right mb-4">
        Sumber, <span id="tglSurat"></span>
    </div>

    <div class="text-center mb-4">
        <h5 class="text-decoration-underline font-weight-bold">LAPORAN RINGKAS DATA KESEJAHTERAAN (DTSEN)</h5>
        <p>Nomor: 460 / <span id="nomorSurat">001</span> / TKSK-SBR / 2026</p>
    </div>

    <div class="content">
        <p>Berdasarkan hasil pemutakhiran data DTSEN periode <strong id="periodeData">-</strong>, berikut disampaikan ringkasan statistik wilayah:</p>
        
        <table class="table table-bordered">
            <tr>
                <th width="40%">Wilayah</th>
                <td id="namaWilayah">-</td>
            </tr>
            <tr>
                <th>Total KK</th>
                <td id="totalSurat">-</td>
            </tr>
            <tr>
                <th>Prioritas (Desil 1-2)</th>
                <td id="prioSurat">-</td>
            </tr>
        </table>

        <p class="mt-4">Demikian data ini disampaikan untuk dipergunakan sebagai dasar perencanaan program perlindungan sosial di tingkat desa/kelurahan.</p>
    </div>

    <div class="qr-section row">
        <div class="col-8">
            <p class="small text-muted italic">** Dokumen ini sah dan diverifikasi secara digital menggunakan kunci publik (Public Key). Pindai QR Code untuk validasi keaslian data.</p>
        </div>
        <div class="col-4 text-center">
            <p class="mb-1">TKSK KEC. SUMBER</p>
            <div id="qrcode" class="my-2"></div>
            <p class="font-weight-bold mb-0">KOORDINATOR</p>
            <small>NIP. TKSK-SBR.2026.01</small>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Ambil data dari sessionStorage (dikirim dari index.html) atau default
        const selectedIndex = localStorage.getItem('lastSelectedWilayah') || 0;

        fetch('data/dtsen.json')
            .then(res => res.json())
            .then(data => {
                const w = data.wilayah[selectedIndex];
                const d = w.desil;
                
                // Isi Elemen Surat
                document.getElementById('tglSurat').innerText = new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});
                document.getElementById('periodeData').innerText = data.updated;
                document.getElementById('namaWilayah').innerText = w.nama;
                document.getElementById('totalSurat').innerText = w.total_kk.toLocaleString('id-ID') + " KK";
                
                const prio = (((d[0] + d[1]) / w.total_kk) * 100).toFixed(1);
                document.getElementById('prioSurat').innerText = prio + "% dari populasi";

                // GENERATE SIGNATURE DATA (Simulasi Hash Data)
                // Ini menggabungkan data krusial untuk diverifikasi
                const signContent = {
                    schema: "dtsen-signature-v1",
                    wilayah: w.nama,
                    total: w.total_kk,
                    hash: btoa(w.nama + w.total_kk + data.updated), // Simulasi hash
                    publicKeyPath: "public_key.pem"
                };

                // Render QR Code
                new QRCode(document.getElementById("qrcode"), {
                    text: JSON.stringify(signContent),
                    width: 100,
                    height: 100,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
            });
    });
</script>
</body>
</html>
