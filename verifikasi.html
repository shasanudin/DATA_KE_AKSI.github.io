<script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.25/jsrsasign-all-min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
    // Metadata Kunci Publik sesuai input Anda
    const keyMetadata = {
        "pem": `-----BEGIN PUBLIC KEY-----
MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEzzmj3tgm7GPSL4uNBnIBJAickAkk
KJPSoGQk0G8vqCjwMz6N3GZWJn3rBbbLJps4tUtKzq7+8cfLZfdzxoxASA==
-----END PUBLIC KEY-----`,
        "pemilik": "Shidiq Hasanudin, S.IP",
        "jabatan": "TKSK Kecamatan Sumber",
        "alg": "ECDSA-secp256r1-SHA256"
    };

    const html5QrCode = new Html5Qrcode("reader");
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };

    html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess);

    function onScanSuccess(decodedText) {
        html5QrCode.stop();
        document.getElementById('reader').style.display = 'none';
        
        const resultBox = document.getElementById('result');
        const icon = document.getElementById('statusIcon');
        const title = document.getElementById('statusTitle');
        const detail = document.getElementById('statusDetail');
        
        resultBox.style.display = 'block';

        try {
            const payload = JSON.parse(decodedText);
            
            // Verifikasi menggunakan ECDSA SHA256
            const sig = new KJUR.crypto.Signature({"alg": "SHA256withECDSA"});
            sig.init(keyMetadata.pem);
            sig.updateString(payload.msg);
            
            const isValid = sig.verify(payload.sig);

            if (isValid) {
                resultBox.className = "result-box valid";
                icon.innerHTML = "✅";
                title.innerText = "VERIFIKASI BERHASIL";
                
                // Menampilkan detail metadata pemilik kunci
                detail.innerHTML = `
                    <div class="p-2 bg-white rounded border mb-3">
                        <small class="text-muted d-block">Penanda Tangan Digital:</small>
                        <strong>${keyMetadata.pemilik}</strong><br>
                        <span class="badge badge-primary">${keyMetadata.jabatan}</span>
                    </div>
                    <p><strong>Konten Dokumen:</strong> ${payload.msg}</p>
                    <p><strong>ID Dokumen:</strong> <code class="text-dark">${payload.id}</code></p>
                    <hr>
                    <p class="text-success small mb-0">
                        <i class="fas fa-shield-alt"></i> Sertifikat berlaku hingga 31 Des 2028. 
                        Data ini dijamin otentik oleh protokol ${keyMetadata.alg}.
                    </p>
                `;
            } else {
                throw new Error("Invalid Signature");
            }
        } catch (e) {
            resultBox.className = "result-box invalid";
            icon.innerHTML = "❌";
            title.innerText = "DATA TIDAK VALID";
            detail.innerHTML = `
                <p>Tanda tangan digital tidak cocok atau data telah dimodifikasi secara ilegal.</p>
                <small>Pastikan Anda memindai QR Code resmi dari aplikasi TKSK Sumber.</small>
            `;
        }
    }

    function resetScanner() {
        location.reload();
    }
</script>
